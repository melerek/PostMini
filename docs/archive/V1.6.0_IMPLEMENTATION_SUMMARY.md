# PostMini v1.6.0 - Folders & Collection Variables Implementation Summary

## üéØ Overview
This document summarizes the major UX improvements implemented for v1.6.0, focusing on request organization, collection-level variables, and enhanced workflow management.

## ‚ú® Key Features Implemented

### 1. Request Folders & Nesting
**Status**: ‚úÖ Complete

#### What Was Added:
- **Folder Support**: Organize requests within collections using folders
- **Nested Folders**: Support for subfolders (unlimited nesting depth)
- **Visual Distinction**: 
  - Collections: Blue briefcase icon (üíº)
  - Folders: Orange folder icon (üìÅ)
  - Requests: Colored method badges (GET, POST, etc.)

#### Database Changes:
- New `folders` table with:
  - `id`, `collection_id`, `parent_id` (for nesting), `name`, `created_at`
- Added `folder_id` column to `requests` table

#### UI Features:
- Right-click context menus for:
  - **Collections**: Add Folder, Add Request, Manage Variables, Export, Run Tests, Rename, Duplicate, Delete
  - **Folders**: Add Subfolder, Add Request, Rename, Delete
  - **Requests**: Open, Open in New Tab, Move to (folder submenu), Copy as cURL, Rename, Duplicate, Delete
- Drag-free organization via context menus
- Expanded state preservation when reloading tree

### 2. Collection Variables
**Status**: ‚úÖ Complete

#### What Was Added:
- Collection-level variables that apply to all requests in a collection
- Variable management dialog accessible via collection context menu
- **Variable Resolution Hierarchy**: Collection variables > Environment variables > Dynamic variables

#### Database Changes:
- New `collection_variables` table with:
  - `id`, `collection_id`, `key`, `value`, `description`
  - Unique constraint on `(collection_id, key)` pair

#### UI Features:
- **Collection Variables Dialog**:
  - View all collection variables in a table
  - Add new variables with key, value, and optional description
  - Edit existing variables
  - Delete variables
  - Clean, professional interface with helpful info text

#### Variable Resolution:
- Collection variables take precedence over environment variables
- Variables use `{{variableName}}` syntax
- Automatic substitution in URLs, params, headers, body, and auth tokens
- Warning dialog for unresolved variables before sending request

### 3. Icon System
**Status**: ‚úÖ Complete

#### New Icons Created:
All icons are SVG-based for crisp rendering at any size, with separate light and dark theme versions:

- **Collection Icons**:
  - `collection-icon.svg` (light): Blue briefcase for light theme
  - `collection-icon-dark.svg` (dark): Darker blue briefcase for dark theme

- **Folder Icons**:
  - `folder-icon.svg` (light): Orange/amber folder for light theme
  - `folder-icon-dark.svg` (dark): Golden folder for dark theme

#### Benefits:
- Professional, modern appearance
- Clear visual hierarchy (Collection ‚Üí Folder ‚Üí Request)
- Theme-aware (automatically switches between light/dark icons)
- Scalable vector graphics (no pixelation)

## üìÅ Files Created/Modified

### New Files:
1. `src/ui/dialogs/collection_variables_dialog.py` - Collection variables management UI
2. `assets/icons/collection-icon.svg` - Collection icon (light theme)
3. `assets/icons/collection-icon-dark.svg` - Collection icon (dark theme)
4. `assets/icons/folder-icon.svg` - Folder icon (light theme)
5. `assets/icons/folder-icon-dark.svg` - Folder icon (dark theme)

### Modified Files:
1. `src/core/database.py`:
   - Added `folders` table
   - Added `collection_variables` table
   - Added `folder_id` column to `requests` table
   - Implemented folder CRUD operations
   - Implemented collection variables CRUD operations

2. `src/ui/main_window.py`:
   - Updated `_load_collections()` to support folders with nesting
   - Added folder management methods:
     - `_add_folder_to_collection()`
     - `_add_folder_to_folder()`
     - `_add_request_to_folder()`
     - `_rename_folder()`
     - `_delete_folder_from_menu()`
     - `_move_request_to_folder()`
     - `_manage_collection_variables()`
   - Enhanced `_show_tree_context_menu()` with folder support
   - Updated `_delete_selected()` to handle folders
   - Enhanced `_send_request()` with collection variable resolution

3. `src/features/variable_substitution.py`:
   - Added `get_active_variables()` method to `EnvironmentManager`
   - Updated `substitute_in_request()` to accept `extra_variables` parameter
   - Implemented variable merging with proper precedence

## üé® User Experience

### Before:
- All requests were flat within collections
- No way to organize related requests
- Only environment-level variables

### After:
- **Hierarchical Organization**: Collections ‚Üí Folders ‚Üí Subfolders ‚Üí Requests
- **Collection-Specific Variables**: No need to create separate environments for collection-specific values
- **Professional Icons**: Clear visual distinction between collections, folders, and requests
- **Flexible Management**: Easy-to-use context menus for all operations

## üîÑ Variable Resolution Flow

```
1. User references {{apiKey}} in request URL
2. System checks:
   a. Collection variables for current collection ‚Üí Found? Use it
   b. Active environment variables ‚Üí Found? Use it
   c. Dynamic variables ($timestamp, $guid, etc.) ‚Üí Resolve
   d. None found? ‚Üí Mark as unresolved
3. Show warning if unresolved variables exist
4. User confirms or cancels request
```

## üí° Usage Examples

### Example 1: Organizing an E-commerce API
```
üì¶ E-commerce API [15]
  üìÅ Authentication
    GET Login
    POST Register
    POST Refresh Token
  üìÅ Products
    GET List Products
    GET Product Details
    POST Create Product
    PUT Update Product
    DELETE Delete Product
  üìÅ Orders
    GET List Orders
    POST Create Order
    GET Order Status
```

### Example 2: Collection Variables
```
Collection: "Production API"
Variables:
  baseUrl: https://api.production.com
  apiKey: prod-12345-xyz
  timeout: 5000

Collection: "Staging API"
Variables:
  baseUrl: https://api.staging.com
  apiKey: stage-67890-abc
  timeout: 3000

Request URL: {{baseUrl}}/v1/users?key={{apiKey}}
‚Üí Resolves differently based on selected collection
```

## üöÄ Next Steps (Not Yet Implemented)

### Bulk Operations (Deferred):
- Multi-select requests (Ctrl+Click, Shift+Click)
- Bulk delete selected requests
- Bulk move selected requests to folder
- Bulk duplicate

**Reason for Deferral**: Core folder and variable functionality is more critical. Bulk operations can be added in a future update once users have tested the core features.

## üîß Technical Details

### Database Schema:

```sql
-- Folders table
CREATE TABLE folders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    collection_id INTEGER NOT NULL,
    parent_id INTEGER,  -- NULL for root-level folders
    name TEXT NOT NULL,
    created_at TEXT NOT NULL,
    FOREIGN KEY (collection_id) REFERENCES collections(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES folders(id) ON DELETE CASCADE
);

-- Collection variables table
CREATE TABLE collection_variables (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    collection_id INTEGER NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    description TEXT,
    FOREIGN KEY (collection_id) REFERENCES collections(id) ON DELETE CASCADE,
    UNIQUE(collection_id, key)
);

-- Updated requests table
ALTER TABLE requests ADD COLUMN folder_id INTEGER REFERENCES folders(id) ON DELETE SET NULL;
```

### API Methods:

**Folders**:
- `create_folder(collection_id, name, parent_id=None) -> int`
- `get_folders_by_collection(collection_id) -> List[Dict]`
- `get_folder(folder_id) -> Optional[Dict]`
- `update_folder(folder_id, name=None, parent_id=None)`
- `delete_folder(folder_id)`
- `move_request_to_folder(request_id, folder_id)`
- `get_requests_by_folder(folder_id, collection_id) -> List[Dict]`

**Collection Variables**:
- `create_collection_variable(collection_id, key, value, description="") -> int`
- `get_collection_variables(collection_id) -> Dict[str, str]`
- `get_collection_variables_with_metadata(collection_id) -> List[Dict]`
- `update_collection_variable(variable_id, key=None, value=None, description=None)`
- `delete_collection_variable(variable_id)`
- `delete_collection_variables_by_collection(collection_id)`

## üìä Impact

### Organization Benefits:
- **Before**: 50 requests in one flat list ‚Üí Hard to find, hard to manage
- **After**: 50 requests organized into 5 folders ‚Üí Easy navigation, logical grouping

### Variable Management:
- **Before**: Need to create multiple environments for different API keys/base URLs per collection
- **After**: One environment for deployment stage (dev/staging/prod), collection variables for API-specific config

### Visual Clarity:
- **Before**: Emoji icons (üìÅ) looked inconsistent across platforms
- **After**: Professional SVG icons render perfectly on all platforms

## ‚úÖ Testing Recommendations

1. **Folder Operations**:
   - Create root-level folders in collections
   - Create nested subfolders
   - Move requests between folders
   - Delete folders (verify CASCADE behavior)
   - Rename folders

2. **Collection Variables**:
   - Create variables in collection
   - Use variables in requests
   - Test precedence (collection vars should override environment vars)
   - Edit and delete variables
   - Verify unique constraint on (collection_id, key)

3. **UI/UX**:
   - Test theme switching (icons should change)
   - Test tree expansion/collapse
   - Test context menus on all item types
   - Verify visual hierarchy is clear

4. **Edge Cases**:
   - Empty collections
   - Empty folders
   - Circular reference prevention (folder can't be its own parent)
   - Long folder/variable names
   - Special characters in variable values

## üéì User Documentation Needed

**Topics to Cover**:
1. How to create and organize folders
2. How to move requests between folders
3. How to manage collection variables
4. Understanding variable resolution hierarchy
5. Best practices for organizing large collections
6. When to use collection variables vs environment variables

---

**Version**: 1.6.0  
**Date**: October 21, 2025  
**Status**: Implementation Complete, Ready for Testing

